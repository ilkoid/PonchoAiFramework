# PonchoFramework Configuration File
# This file contains the main configuration for the Poncho AI Framework

# Models Configuration
models:
  # DeepSeek Chat Model - Primary text generation model
  deepseek-chat:
    provider: "deepseek"
    model_name: "deepseek-chat"
    api_key: "${DEEPSEEK_API_KEY}"
    base_url: "https://api.deepseek.com/v1"
    max_tokens: 4000
    temperature: 0.7
    timeout: 30s
    retry:
      max_attempts: 3
      backoff: "exponential"
      base_delay: 1s
      max_delay: 30s
    supports:
      vision: false
      tools: true
      stream: true
      system: true
      json_mode: true
    custom_params:
      top_p: 0.9
      frequency_penalty: 0.0
      presence_penalty: 0.0
      response_format: "auto"
      thinking: false

  # DeepSeek Coder Model - For code generation tasks
  deepseek-coder:
    provider: "deepseek"
    model_name: "deepseek-coder"
    api_key: "${DEEPSEEK_API_KEY}"
    base_url: "https://api.deepseek.com/v1"
    max_tokens: 8000
    temperature: 0.1
    timeout: 45s
    retry:
      max_attempts: 2
      backoff: "linear"
      base_delay: 2s
      max_delay: 20s
    supports:
      vision: false
      tools: true
      stream: true
      system: true
      json_mode: true
    custom_params:
      top_p: 0.95
      frequency_penalty: 0.0
      presence_penalty: 0.0
      response_format: "auto"

  # Z.AI GLM Vision Model - For fashion image analysis
  glm-vision:
    provider: "zai"
    model_name: "glm-4.6v"
    api_key: "${ZAI_API_KEY}"
    base_url: "https://open.bigmodel.cn/api/paas/v4"
    max_tokens: 2000
    temperature: 0.5
    timeout: 60s
    retry:
      max_attempts: 2
      backoff: "exponential"
      base_delay: 2s
      max_delay: 60s
    supports:
      vision: true
      tools: true
      stream: true
      system: true
      json_mode: false
    custom_params:
      top_p: 0.8
      max_image_size: "10MB"
      thinking:
        type: "enabled"
        budget_tokens: 1000

  # Z.AI GLM 4.6v Flash Vision Model - Vision processing
  glm-4.6v-flash:
    provider: "zai"
    model_name: "glm-4.6v-flash"
    api_key: "${ZAI_API_KEY}"
    base_url: "https://open.bigmodel.cn/api/paas/v4"
    max_tokens: 1500
    temperature: 0.3
    timeout: 30s
    retry:
      max_attempts: 3
      backoff: "exponential"
      base_delay: 1s
      max_delay: 30s
    supports:
      vision: true
      tools: false
      stream: true
      system: true
      json_mode: false
    custom_params:
      top_p: 0.7
      max_image_size: "5MB"
      thinking: "disabled"

  # Z.AI GLM Text Model - Primary text generation
  glm-chat:
    provider: "zai"
    model_name: "glm-4.6"
    api_key: "${ZAI_API_KEY}"
    base_url: "https://open.bigmodel.cn/api/paas/v4"
    max_tokens: 3000
    temperature: 0.6
    timeout: 30s
    retry:
      max_attempts: 3
      backoff: "exponential"
      base_delay: 1s
      max_delay: 30s
    supports:
      vision: false
      tools: true
      stream: true
      system: true
      json_mode: true
    custom_params:
      top_p: 0.85
      thinking:
        type: "disabled"

  # Z.AI GLM Long Context Model - For large document processing
  glm-long:
    provider: "zai"
    model_name: "glm-4.6-long"
    api_key: "${ZAI_API_KEY}"
    base_url: "https://open.bigmodel.cn/api/paas/v4"
    max_tokens: 8000
    temperature: 0.4
    timeout: 60s
    retry:
      max_attempts: 2
      backoff: "exponential"
      base_delay: 3s
      max_delay: 60s
    supports:
      vision: false
      tools: true
      stream: true
      system: true
      json_mode: true
    custom_params:
      top_p: 0.9
      thinking:
        type: "enabled"
        budget_tokens: 2000

# Tools Configuration
tools:
  # Article Importer Tool
  article_importer:
    enabled: true
    timeout: 30s
    retry:
      max_attempts: 3
      backoff: "exponential"
      base_delay: 1s
      max_delay: 30s
    cache:
      enabled: true
      ttl: 300s
      max_size: 1000
    dependencies: []
    custom_params:
      max_images: 10
      image_optimization: true

  # Wildberries Categories Tool
  wb_categories:
    enabled: true
    timeout: 15s
    retry:
      max_attempts: 2
      backoff: "linear"
      base_delay: 2s
      max_delay: 10s
    cache:
      enabled: true
      ttl: 1800s
      max_size: 500
    dependencies: []
    custom_params:
      locale: "ru"
      include_inactive: false

  # S3 Storage Tool
  s3_storage:
    enabled: true
    timeout: 45s
    retry:
      max_attempts: 3
      backoff: "exponential"
      base_delay: 2s
      max_delay: 60s
    cache:
      enabled: false
    dependencies: []
    custom_params:
      bucket: "plm-ai"
      region: "ru-central1"

  # Vision Analysis Tool
  vision_analyzer:
    enabled: true
    timeout: 60s
    retry:
      max_attempts: 2
      backoff: "exponential"
      base_delay: 5s
      max_delay: 120s
    cache:
      enabled: true
      ttl: 3600s
      max_size: 100
    dependencies: ["glm-vision"]
    custom_params:
      analysis_types: ["fashion", "materials", "style", "season"]
      confidence_threshold: 0.7

# Flows Configuration
flows:
  # Article Processor Flow
  article_processor:
    enabled: true
    timeout: 120s
    parallel: false
    retry:
      max_attempts: 2
      backoff: "exponential"
      base_delay: 10s
      max_delay: 300s
    dependencies:
      - "article_importer"
      - "wb_categories"
      - "vision_analyzer"
    custom_params:
      auto_categorize: true
      generate_description: true
      validate_characteristics: true

  # Mini-Agent Flow
  mini_agent:
    enabled: true
    timeout: 180s
    parallel: true
    retry:
      max_attempts: 1
      backoff: "linear"
      base_delay: 5s
      max_delay: 30s
    dependencies:
      - "deepseek-chat"
      - "glm-vision"
      - "wb_categories"
    custom_params:
      max_iterations: 5
      temperature_schedule: [0.7, 0.5, 0.3]

# Logging Configuration
logger:
  level: "info"  # debug, info, warn, error
  format: "text"  # text, json
  output: "stdout"  # stdout, stderr, file path
  file_config:
    max_size: "100MB"
    max_backups: 5
    max_age: "30d"
    compress: true
  fields:
    service: "poncho-framework"
    version: "1.0.0"
    environment: "${PONCHO_ENV:development}"

# Metrics Configuration
metrics:
  enabled: true
  interval: 30s
  endpoint: ""  # Prometheus push gateway endpoint
  labels:
    service: "poncho-framework"
    instance: "${HOSTNAME:localhost}"
  collectors:
    - "requests"
    - "duration"
    - "errors"
    - "cache_hits"

# Cache Configuration
cache:
  type: "memory"  # memory, redis
  memory:
    max_size: "100MB"
    ttl: "1h"
    cleanup_interval: "10m"
  redis:
    url: "${REDIS_URL:redis://localhost:6379}"
    ttl: "1h"
    max_connections: 10
    key_prefix: "poncho:"

# Security Configuration
security:
  api_keys:
    deepseek: "${DEEPSEEK_API_KEY}"
    zai: "${ZAI_API_KEY}"
    wildberries: "${WB_API_CONTENT_KEY}"
    s3_access_key: "${S3_ACCESS_KEY}"
    s3_secret_key: "${S3_SECRET_KEY}"
  rate_limiting:
    enabled: true
    requests_per_minute: 100
    burst: 20
  encryption:
    enabled: false
    algorithm: "AES-256-GCM"
    key_source: "env"  # env, file, kms

# S3 Configuration
s3:
  url: "https://storage.yandexcloud.net"
  region: "ru-central1"
  bucket: "plm-ai"
  endpoint: "storage.yandexcloud.net"
  use_ssl: true
  access_key: "${S3_ACCESS_KEY}"
  secret_key: "${S3_SECRET_KEY}"
  timeout: 30s
  retry:
    max_attempts: 3
    backoff: "exponential"
    base_delay: 1s

# Wildberries Configuration
wildberries:
  base_url: "https://content-api.wildberries.ru"
  timeout: 30s
  api_key: "${WB_API_CONTENT_KEY}"
  retry:
    max_attempts: 3
    backoff: "exponential"
    base_delay: 2s
  rate_limit:
    requests_per_second: 10
    burst: 20

# Image Resize Configuration V2.0
image_resize:
  # Global settings
  enabled: true
  max_memory_mb: 100
  cache_size_mb: 50

  # Default strategy to use
  default_strategy: "vision_optimized"

  # Auto-apply resize for models
  auto_resize: true
  model_strategies:
    "glm-vision": "vision_optimized"
    "glm-4.6v-flash": "vision_optimized"
    "deepseek-chat": "text_optimized"
    "deepseek-coder": "code_optimized"

  # Batch processing settings
  batch_size: 10
  parallel_resize: false
  max_concurrency: 3

  # Quality presets
  default_preset: "high_quality"
  default_format: "jpeg"

  # Size thresholds for automatic processing decisions
  size_thresholds:
    small_image_kb: 100      # < 100KB - no resize needed
    medium_image_kb: 1024    # 100KB-1MB - standard resize
    large_image_kb: 5120     # 1-5MB - aggressive resize
    huge_image_kb: 10240     # > 10MB - use temp files

  # Safety limits
  limits:
    max_images_per_context: 50
    max_memory_per_context_mb: 50
    max_concurrent_resizes: 5
    resize_timeout_seconds: 30
    max_batch_size: 20

  # Advanced options
  smart_crop: false
  preserve_metadata: false
  progressive_jpeg: false

  # Monitoring and debugging
  monitoring: true
  log_operations: false
  profiling: false

  # Define resize strategies
  strategies:
    vision_optimized:
      name: "vision_optimized"
      description: "Optimized for vision models (1024x1024, high quality)"
      max_width: 1024
      max_height: 1024
      max_file_size_kb: 500
      quality: 85
      target_format: "jpeg"
      enabled: true
      priority: 100
      interpolation: "lanczos"
      sharpening:
        enabled: true
        amount: 0.3
        radius: 1.0
        threshold: 0.05
      noise_reduction:
        enabled: false
        strength: 0.1
        smoothing: true

    text_optimized:
      name: "text_optimized"
      description: "Optimized for text analysis (512x512, medium quality)"
      max_width: 512
      max_height: 512
      max_file_size_kb: 200
      quality: 75
      target_format: "jpeg"
      enabled: true
      priority: 50
      interpolation: "bicubic"
      sharpening:
        enabled: false
      noise_reduction:
        enabled: true
        strength: 0.2
        smoothing: true

    code_optimized:
      name: "code_optimized"
      description: "Optimized for code screenshots (800x600, high quality)"
      max_width: 800
      max_height: 600
      max_file_size_kb: 300
      quality: 90
      target_format: "png"
      enabled: true
      priority: 75
      interpolation: "lanczos"
      sharpening:
        enabled: true
        amount: 0.5
        radius: 1.5
        threshold: 0.1

    high_quality:
      name: "high_quality"
      description: "High quality for detailed analysis (2048x2048, maximum quality)"
      max_width: 2048
      max_height: 2048
      max_file_size_kb: 1024
      quality: 95
      target_format: "png"
      enabled: true
      priority: 90
      interpolation: "lanczos"
      sharpening:
        enabled: true
        amount: 0.2
        radius: 0.8
        threshold: 0.02
      noise_reduction:
        enabled: true
        strength: 0.1
        smoothing: false

    thumbnail:
      name: "thumbnail"
      description: "Small thumbnails for previews (150x150, low quality)"
      max_width: 150
      max_height: 150
      max_file_size_kb: 50
      quality: 70
      target_format: "jpeg"
      enabled: true
      priority: 10
      interpolation: "bilinear"

  # Quality presets for quick selection
  quality_presets:
    ultra_high:
      name: "ultra_high_preset"
      description: "Maximum quality preservation"
      max_width: 4096
      max_height: 4096
      max_file_size_kb: 2048
      quality: 98
      target_format: "png"
      enabled: true

    high:
      name: "high_preset"
      description: "High quality for detailed work"
      max_width: 2048
      max_height: 2048
      max_file_size_kb: 1024
      quality: 92
      target_format: "png"
      enabled: true

    medium:
      name: "medium_preset"
      description: "Balanced quality and size"
      max_width: 1024
      max_height: 1024
      max_file_size_kb: 500
      quality: 85
      target_format: "jpeg"
      enabled: true

    low:
      name: "low_preset"
      description: "Small size, acceptable quality"
      max_width: 512
      max_height: 512
      max_file_size_kb: 200
      quality: 75
      target_format: "jpeg"
      enabled: true

  # Format conversion rules
  convert_formats:
    "png": "jpeg"  # Convert PNG to JPEG by default for size reduction
    "bmp": "png"   # Convert BMP to PNG for compression
    "tiff": "png"  # Convert TIFF to PNG for compatibility

  # Flow-specific configurations
  flows:
    article_processor:
      enabled: true
      strategy_name: "vision_optimized"
      quality_preset: "medium"
      max_images: 20
      memory_limit_mb: 50

    fashion_analyzer:
      enabled: true
      strategy_name: "high_quality"
      quality_preset: "high"
      max_images: 10
      memory_limit_mb: 100

    batch_import:
      enabled: true
      strategy_name: "text_optimized"
      quality_preset: "low"
      max_images: 50
      memory_limit_mb: 75

    thumbnail_generator:
      enabled: true
      strategy_name: "thumbnail"
      quality_preset: "low"
      max_images: 100
      memory_limit_mb: 25

# Server Configuration (if running as HTTP service)
server:
  enabled: false
  host: "0.0.0.0"
  port: 8080
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s
  max_header_bytes: 1048576
  tls:
    enabled: false
    cert_file: ""
    key_file: ""

# Development Configuration
development:
  debug_mode: false
  pretty_print: true
  enable_profiling: false
  profiling_port: 6060
  mock_external_apis: false
  log_requests: false
  log_responses: false

# Feature Flags
features:
  enable_vision_analysis: true
  enable_auto_categorization: true
  enable_description_generation: true
  enable_batch_processing: true
  enable_streaming_responses: true
  enable_caching: true
  enable_metrics: true
  enable_rate_limiting: true